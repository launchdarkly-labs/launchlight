(function(g,f){typeof exports==='object'&&typeof module!=='undefined'?f(require('@webexp/shared')):typeof define==='function'&&define.amd?define(['@webexp/shared'],f):(g=typeof globalThis!=='undefined'?globalThis:g||self,f(g.shared));})(this,(function(shared){'use strict';var h=class{constructor(e){this.hoverHighlight=null;this.selectionHighlight=null;this.dragPreview=null;this.animationFrameId=null;this.shadowRoot=e,this.createStyles();}createStyles(){let e=document.createElement("style");e.textContent=`
      .webexp-hover {
        position: fixed;
        border: 2px solid #007bff;
        background: rgba(0, 123, 255, 0.1);
        pointer-events: none;
        z-index: 9999;
        box-sizing: border-box;
        transition: all 0.1s ease-out;
      }
      
      .webexp-selection {
        position: fixed;
        border: 3px solid #28a745;
        background: rgba(40, 167, 69, 0.15);
        pointer-events: none;
        z-index: 10000;
        box-sizing: border-box;
        box-shadow: 0 0 0 1px rgba(40, 167, 69, 0.3);
      }
      
      .webexp-drag-preview {
        position: fixed;
        border: 2px dashed #ffc107;
        background: rgba(255, 193, 7, 0.1);
        pointer-events: none;
        z-index: 10001;
        box-sizing: border-box;
        opacity: 0.8;
      }
    `,this.shadowRoot.appendChild(e);}showHover(e){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.animationFrameId=requestAnimationFrame(()=>{this.hoverHighlight||(this.hoverHighlight=document.createElement("div"),this.hoverHighlight.className="webexp-hover",this.shadowRoot.appendChild(this.hoverHighlight)),this.updateHighlightPosition(this.hoverHighlight,e),this.hoverHighlight.style.display="block";});}hideHover(){this.hoverHighlight&&(this.hoverHighlight.style.display="none");}showSelection(e){this.selectionHighlight||(this.selectionHighlight=document.createElement("div"),this.selectionHighlight.className="webexp-selection",this.shadowRoot.appendChild(this.selectionHighlight)),this.updateHighlightPosition(this.selectionHighlight,e),this.selectionHighlight.style.display="block";}hideSelection(){this.selectionHighlight&&(this.selectionHighlight.style.display="none");}showDragPreview(e){this.dragPreview||(this.dragPreview=document.createElement("div"),this.dragPreview.className="webexp-drag-preview",this.shadowRoot.appendChild(this.dragPreview)),this.updateHighlightPosition(this.dragPreview,e),this.dragPreview.style.display="block";}hideDragPreview(){this.dragPreview&&(this.dragPreview.style.display="none");}updateHighlightPosition(e,t){e.style.left=`${t.x}px`,e.style.top=`${t.y}px`,e.style.width=`${t.w}px`,e.style.height=`${t.h}px`;}clear(){this.hideHover(),this.hideSelection(),this.hideDragPreview();}destroy(){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.clear(),this.hoverHighlight&&(this.hoverHighlight.remove(),this.hoverHighlight=null),this.selectionHighlight&&(this.selectionHighlight.remove(),this.selectionHighlight=null),this.dragPreview&&(this.dragPreview.remove(),this.dragPreview=null);}};function l(i){let e=i.getBoundingClientRect(),t=window.pageXOffset||document.documentElement.scrollLeft,n=window.pageYOffset||document.documentElement.scrollTop,s=window.devicePixelRatio||1;return {x:e.left,y:e.top,w:e.width,h:e.height,scrollX:t,scrollY:n,dpr:s}}function f(i){let e={};for(let t of i.attributes)e[t.name]=t.value;return {tagName:i.tagName,id:i.id||void 0,classes:Array.from(i.classList),attributes:e,textContent:i.textContent?.trim()||void 0,role:i.getAttribute("role")||void 0}}function d(i){let e=i.getAttribute("data-webexp-id");if(e)return `[data-webexp-id="${CSS.escape(e)}"]`;let t=["data-testid","data-test","data-cy"];for(let s of t){let r=i.getAttribute(s);if(r)return `[${s}="${CSS.escape(r)}"]`}if(i.id)return `#${CSS.escape(i.id)}`;let n=i.getAttribute("role");return n?`[role="${CSS.escape(n)}"]`:w(i)}function w(i){let e=[],t=i;for(;t&&t!==document.body;){let n=t.tagName.toLowerCase(),r=Array.from(t.parentElement?.children||[]).findIndex(o=>o===t);r===0?e.unshift(n):e.unshift(`${n}:nth-child(${r+1})`),t=t.parentElement;}return e.join(" > ")}function b(i){try{return document.querySelectorAll(i).length===1}catch{return  false}}function E(i){let e=i;for(;e&&e!==document.body;){if(e.hasAttribute("data-webexp-container"))return  true;e=e.parentElement;}return  false}function y(i){let e=i;for(;e&&e!==document.body;){if(e.hasAttribute("data-webexp-container"))return d(e);e=e.parentElement;}}function M(i){return i.hasAttribute("draggable")?i.getAttribute("draggable")==="true":["draggable","sortable-item","list-item"].some(n=>i.classList.contains(n))}function a(i){let e=d(i),t=l(i),n=f(i),s=E(i),r=b(e),o=M(i),c=y(i);return {el:i,selector:e,bounds:t,meta:n,containerSafe:s,selectorUnique:r,canDrag:o,nearestContainerSelector:c}}function g(i){return {selector:i.selector,bounds:i.bounds,metadata:i.meta,containerSafe:i.containerSafe,selectorUnique:i.selectorUnique,canDrag:i.canDrag,nearestContainerSelector:i.nearestContainerSelector}}var u=class{constructor(e){this.containers=new Map;this.highlightElements=new Map;this.shadowRoot=e;}scanContainers(){this.containers.clear(),document.querySelectorAll('[data-webexp-container="true"]').forEach(t=>{let n=d(t),s=l(t),r={tagName:t.tagName,id:t.id||void 0,classes:Array.from(t.classList),attributes:{"data-webexp-container":"true"},textContent:void 0,role:t.getAttribute("role")||void 0},o={el:t,selector:n,bounds:s,meta:r,containerSafe:true,selectorUnique:true,canDrag:false,nearestContainerSelector:void 0};this.containers.set(n,o);}),this.updateContainerHighlights();}getContainerSelectors(){return Array.from(this.containers.keys())}isElementInSafeContainer(e){for(let t of this.containers.values())if(t.el.contains(e))return  true;return  false}findNearestContainer(e){let t=e;for(;t&&t!==document.body;){for(let n of this.containers.values())if(n.el===t)return n;t=t.parentElement;}return null}getDropTargets(){let e=[];for(let t of this.containers.values()){e.push({selector:t.selector,bounds:t.bounds,position:"append"});let n=Array.from(t.el.children);n.forEach((s,r)=>{let o=l(s);e.push({selector:t.selector,bounds:o,position:"before"}),r===n.length-1&&e.push({selector:t.selector,bounds:o,position:"after"});});}return e}updateContainerHighlights(){this.highlightElements.forEach(e=>e.remove()),this.highlightElements.clear(),this.containers.forEach((e,t)=>{let n=this.createContainerHighlight(e.bounds);this.shadowRoot.appendChild(n),this.highlightElements.set(t,n);});}createContainerHighlight(e){let t=document.createElement("div");return t.style.cssText=`
      position: fixed;
      left: ${e.x}px;
      top: ${e.y}px;
      width: ${e.w}px;
      height: ${e.h}px;
      border: 2px dashed rgba(0, 255, 0, 0.3);
      background: rgba(0, 255, 0, 0.05);
      pointer-events: none;
      z-index: 9998;
      box-sizing: border-box;
    `,t}destroy(){this.highlightElements.forEach(e=>e.remove()),this.highlightElements.clear(),this.containers.clear();}};var p=class{constructor(){this.sessionId=null;this.parentOrigin=null;this.mode="select";this.settings=null;this.shadowHost=null;this.shadowRoot=null;this.highlightManager=null;this.safeContainerManager=null;this.currentHoverElement=null;this.currentSelection=null;this.isDragging=false;this.dragStartElement=null;this.throttleTimeout=null;this.setupMessageListener(),this.setupRouteChangeListener();}setupMessageListener(){window.addEventListener("message",e=>{if(!this.validateMessage(e))return;let t=e.data;switch(t.type){case "INIT":this.handleInit(t);break;default:this.sendError("UNKNOWN_MESSAGE_TYPE",`Unknown message type: ${t.type}`);}});}validateMessage(e){return !(!e.data||!shared.isBridgeMessage(e.data)||this.sessionId&&e.data.sessionId!==this.sessionId||this.parentOrigin&&e.origin!==this.parentOrigin)}handleInit(e){this.sessionId=e.sessionId,this.parentOrigin=e.parentOrigin,this.mode=e.mode,this.settings=e.settings,this.initializeOverlay(),this.setupEventListeners(),this.scanForSafeContainers(),this.postMessage({type:"INIT",sessionId:this.sessionId,parentOrigin:window.location.origin,mode:this.mode,settings:this.settings});}initializeOverlay(){this.shadowHost=document.createElement("div"),this.shadowHost.id="webexp-overlay-host",this.shadowHost.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 9999;
    `,this.shadowRoot=this.shadowHost.attachShadow({mode:"closed"}),document.body.appendChild(this.shadowHost),this.highlightManager=new h(this.shadowRoot),this.safeContainerManager=new u(this.shadowRoot);}setupEventListeners(){document.addEventListener("mouseover",this.handleMouseOver.bind(this),{capture:true}),document.addEventListener("mouseout",this.handleMouseOut.bind(this),{capture:true}),document.addEventListener("click",this.handleClick.bind(this),{capture:true}),this.mode==="drag"&&(document.addEventListener("mousedown",this.handleMouseDown.bind(this),{capture:true}),document.addEventListener("mousemove",this.handleMouseMove.bind(this),{capture:true}),document.addEventListener("mouseup",this.handleMouseUp.bind(this),{capture:true})),this.setupThrottledListeners();}handleMouseOver(e){let t=e.target;if(!t||t===this.shadowHost)return;this.currentHoverElement=t;let n=a(t);this.highlightManager&&this.highlightManager.showHover(n.bounds),this.postMessage({type:"HOVER",sessionId:this.sessionId,element:g(n)});}handleMouseOut(e){let t=e.target;!t||t===this.shadowHost||(this.currentHoverElement=null,this.highlightManager&&this.highlightManager.hideHover(),this.postMessage({type:"HOVER",sessionId:this.sessionId,element:null}));}handleClick(e){let t=e.target;if(!t||t===this.shadowHost)return;e.preventDefault(),e.stopPropagation(),this.currentSelection=t;let n=a(t);this.highlightManager&&this.highlightManager.showSelection(n.bounds),this.postMessage({type:"SELECT",sessionId:this.sessionId,element:g(n)});}handleMouseDown(e){if(this.mode!=="drag")return;let t=e.target;if(!t||t===this.shadowHost)return;let n=a(t);n.canDrag&&(this.isDragging=true,this.dragStartElement=t,this.highlightManager&&this.highlightManager.showDragPreview(n.bounds),this.postMessage({type:"DRAG_START",sessionId:this.sessionId,element:g(n)}));}handleMouseMove(e){if(!this.isDragging||this.mode!=="drag")return;let t=this.safeContainerManager?.getDropTargets()||[],n={x:e.clientX,y:e.clientY},s=this.findBestDropTarget(t,n);s&&this.postMessage({type:"DRAG_OVER",sessionId:this.sessionId,target:s});}handleMouseUp(e){if(!this.isDragging||this.mode!=="drag")return;this.isDragging=false,this.highlightManager&&this.highlightManager.hideDragPreview();let t={type:"move",source:this.dragStartElement?a(this.dragStartElement).selector:null,target:this.findBestDropTarget(this.safeContainerManager?.getDropTargets()||[],{x:e.clientX,y:e.clientY})};this.postMessage({type:"DRAG_END",sessionId:this.sessionId,operation:t}),this.dragStartElement=null;}findBestDropTarget(e,t){if(e.length===0)return null;let n=e[0],s=1/0;return e.forEach(r=>{let o=r.bounds.x+r.bounds.w/2,c=r.bounds.y+r.bounds.h/2,m=Math.sqrt(Math.pow(t.x-o,2)+Math.pow(t.y-c,2));m<s&&(s=m,n=r);}),{selector:n.selector,position:n.position,bounds:n.bounds}}setupThrottledListeners(){let e=()=>{this.throttleTimeout||(this.throttleTimeout=window.setTimeout(()=>{this.throttleTimeout=null,this.handleLayoutChange();},32));};window.addEventListener("scroll",e,{passive:true}),window.addEventListener("resize",e,{passive:true});}handleLayoutChange(){if(this.scanForSafeContainers(),this.currentHoverElement&&this.highlightManager){let e=a(this.currentHoverElement);this.highlightManager.showHover(e.bounds);}if(this.currentSelection&&this.highlightManager){let e=a(this.currentSelection);this.highlightManager.showSelection(e.bounds);}}setupRouteChangeListener(){let e=history.pushState,t=history.replaceState;history.pushState=(...n)=>{e.apply(history,n),this.handleRouteChange();},history.replaceState=(...n)=>{t.apply(history,n),this.handleRouteChange();},window.addEventListener("popstate",()=>{this.handleRouteChange();});}handleRouteChange(){this.currentHoverElement=null,this.currentSelection=null,this.isDragging=false,this.highlightManager&&this.highlightManager.clear(),setTimeout(()=>{this.scanForSafeContainers();},100);}scanForSafeContainers(){this.safeContainerManager&&this.safeContainerManager.scanContainers();}postMessage(e){if(this.parentOrigin)try{window.parent.postMessage(e,this.parentOrigin);}catch(t){this.sendError("POST_MESSAGE_FAILED",`Failed to post message: ${t}`);}}sendError(e,t){this.postMessage({type:"ERROR",sessionId:this.sessionId,code:e,detail:t});}destroy(){this.throttleTimeout&&clearTimeout(this.throttleTimeout),this.highlightManager&&this.highlightManager.destroy(),this.safeContainerManager&&this.safeContainerManager.destroy(),this.shadowHost&&this.shadowHost.remove(),document.removeEventListener("mouseover",this.handleMouseOver.bind(this),{capture:true}),document.removeEventListener("mouseout",this.handleMouseOut.bind(this),{capture:true}),document.removeEventListener("click",this.handleClick.bind(this),{capture:true}),document.removeEventListener("mousedown",this.handleMouseDown.bind(this),{capture:true}),document.removeEventListener("mousemove",this.handleMouseMove.bind(this),{capture:true}),document.removeEventListener("mouseup",this.handleMouseUp.bind(this),{capture:true});}},v=new p;window.addEventListener("beforeunload",()=>{v.destroy();});typeof window<"u"&&window.__WEBEXP_TEST__&&(window.__webexpBridge=v);}));//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map